---
title: "Debugging and defensive programming"
author: "MACSS 30500 <br /> University of Chicago"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: magula
      highlightLines: true
      highlightLanguage: r
      ratio: 16:9
      countIncrementalSlides: false
---

```{r setup, include = FALSE}
# generate CSS file
library(xaringanthemer)
style_duo_accent(
  primary_color = "#011f4b",
  secondary_color = "#bbd6c7",
  inverse_header_color = "#222222",
  black_color = "#222222",
  header_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  text_font_google = xaringanthemer::google_font("Atkinson Hyperlegible"),
  code_font_google = xaringanthemer::google_font("Source Code Pro"),
  base_font_size = "24px",
  code_font_size = "20px",
  # title_slide_background_image = "https://github.com/uc-dataviz/course-notes/raw/main/images/hexsticker.svg",
  # title_slide_background_size = "contain",
  # title_slide_background_position = "top",
  header_h1_font_size = "2rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.5rem",
  extra_css = list(
    "h1" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h2" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    "h3" = list(
      "margin-block-start" = "0.4rem",
      "margin-block-end" = "0.4rem"
    ),
    ".tiny" = list("font-size" = "70%"),
    ".small" = list("font-size" = "90%"),
    ".midi" = list("font-size" = "150%"),
    ".tiny .remark-code" = list("font-size" = "70%"),
    ".small .remark-code" = list("font-size" = "90%"),
    ".midi .remark-code" = list("font-size" = "150%"),
    ".large" = list("font-size" = "200%"),
    ".xlarge" = list("font-size" = "600%"),
    ".huge" = list(
      "font-size" = "400%",
      "font-family" = "'Montserrat', sans-serif",
      "font-weight" = "bold"
    ),
    ".hand" = list(
      "font-family" = "'Gochi Hand', cursive",
      "font-size" = "125%"
    ),
    ".task" = list(
      "padding-right" = "10px",
      "padding-left" = "10px",
      "padding-top" = "3px",
      "padding-bottom" = "3px",
      "margin-bottom" = "6px",
      "margin-top" = "6px",
      "border-left" = "solid 5px #F1DE67",
      "background-color" = "#F3D03E"
    ),
    ".pull-left" = list(
      "width" = "49%",
      "float" = "left"
    ),
    ".pull-right" = list(
      "width" = "49%",
      "float" = "right"
    ),
    ".pull-left-wide" = list(
      "width" = "70%",
      "float" = "left"
    ),
    ".pull-right-narrow" = list(
      "width" = "27%",
      "float" = "right"
    ),
    ".pull-left-narrow" = list(
      "width" = "27%",
      "float" = "left"
    ),
    ".pull-right-wide" = list(
      "width" = "70%",
      "float" = "right"
    ),
    ".blue" = list(color = "#2A9BB7"),
    ".purple" = list(color = "#a493ba"),
    ".yellow" = list(color = "#f1de67"),
    ".gray" = list(color = "#222222")
  )
)

source(here::here("R", "slide-opts.R"))
xaringanExtra::use_panelset()
knitr::opts_chunk$set(
  warning = TRUE,
  message = TRUE
)
```

```{r pkgs, include = FALSE, cache = FALSE}
library(tidyverse)
library(here)
library(countdown)

set.seed(1234)
theme_set(theme_minimal(base_size = rcis::base_size))
```

class: inverse, middle

## Agenda

* Define a computer bug
* Practice
* Debugging 
* Defensive programming (preventing bugs)
  * Coding style
  * Condition handling

<!-- 
we are going to define what is a bug
then we dive in with some practice finding and fixing bugs, I'd like to ask you to do this in groups of 2-3 people this time as it can be fun!
then we de-brief and talk about some basic tips for debugging
the rest of today is on preventing bugs before they occur that is defensive programming: it can be achieved with style, and condition handling -- other than with experience but that's not something we can fix with a tip
-->

---

### Bugs

A **bug** is an error or flaw in a computer program that causes it to produce an incorrect result or to behave in unintended ways.

When we talk about bugs, we refer to **two main types:** 
* syntactic bugs (such as typos)
* bugs resulting from a misunderstanding of R's rules

We all encounter both types of bugs!

Fixing the latter requires time and experience (i.e., it’s not a quick fix), but we can address syntactic bugs more quickly by improving our coding style!

--

Before we dive into debugging tips, let's begin with some practice!

---

class: inverse, middle

## Practice finding bugs in code

Download today's class materials from the website.

---

class: inverse, middle

## Debugging

Make sure to review "Debugging R code" in [What They Forgot to Teach You About R](https://rstats.wtf/debugging-r), for more!

---

### Basic debugging techniques

What debugging tips did you learn from the practice exercises?

--

1. Realize that you have a bug

1. Figure out where it is
   - read your code out loud
   - use `print()` statements to check each line
   - take a deep breath!

1. Fix it

---

### The call stack

**Often, the actual cause of a problem is not in the line of code we run.**

For example, consider these two functions: `f` which processes an input `x`, and `g`, which calls function `f`. In our code, we call function `g` and we get an error, but the problem is actually in function `f`:

```{r callstack, error = TRUE}

f <- function(x) x + 1
g <- function(x) f(x)
g("a")
```
--

We cannot fix function `g`, because the problem does not occur there. We need to fix function `f` which triggers the call sequence! 

Use `traceback()`, which is often shown automatically in RStudio, and read it from bottom to top (the line at the top is where the error occurred)

---

class: inverse, middle

## Defensive programming

---

### Defensive programming

**Defensive programming:** preventing bugs from occurring in the first place, which involves 

#### 1. Coding Style:
* Notation and names
* Syntax (spacing, curly braces, line length, indentation, etc.)
* Comments

#### 2. Condition handling

---

class: inverse, middle

## Coding Style 

Review the [tidyverse style guide](https://style.tidyverse.org/) 

We will go over some key concepts from this guide, and review general style guidelines we learned in week 1!

<!-- do this rather briefly as for the most part no new concepts; so we spend more time on the second tip for defensive programming: condition handling -->

---

### Writing code

Programming |	Language
------------|----------
Scripts |	Essays
Sections | Paragraphs
Lines Breaks | Sentences
Parentheses |	Punctuation
Functions |	Verbs
Variables |	Nouns

---

### A text with no syntax

Text taken from a speech given by Ronald Reagan in 1987, after the spacial Challenger exploded on take off. Reagan's address: https://youtu.be/Qa7icmqgsow
 
"weve grown used to wonders in this century its hard to dazzle us but for 25 years the united states space program has been doing just that weve grown used to the idea of space and perhaps we forget that weve only just begun were still pioneers they the members of the Challenger crew were pioneers and i want to say something to the school children of America who were watching the live coverage of the shuttles takeoff i know it is hard to understand but sometimes painful things like this happen its all part of the process of exploration and discovery its all part of taking a chance and expanding mans horizons the future doesnt belong to the fainthearted it belongs to the brave the challenger crew was pulling us into the future and well continue to follow them the crew of the space shuttle challenger honored us by the manner in which they lived their lives we will never forget them nor the last time we saw them this morning as they prepared for the journey and waved goodbye and slipped the surly bonds of earth to touch the face of god"


---

### A text with syntax

"We've grown used to wonders in this century. It's hard to dazzle us. But for 25 years the United States space program has been doing just that. We've grown used to the idea of space, and perhaps we forget that we've only just begun. We're still pioneers. They, the members of the Challenger crew, were pioneers.

And I want to say something to the school children of America who were watching the live coverage of the shuttle's takeoff. I know it is hard to understand, but sometimes painful things like this happen. It's all part of the process of exploration and discovery. It's all part of taking a chance and expanding man's horizons. The future doesn't belong to the fainthearted; it belongs to the brave. The Challenger crew was pulling us into the future, and we'll continue to follow them....

The crew of the space shuttle Challenger honoured us by the manner in which they lived their lives. We will never forget them, nor the last time we saw them, this morning, as they prepared for the journey and waved goodbye and 'slipped the surly bonds of earth' to 'touch the face of God.'"

---

### Short and clear object names

```r
# optimal (short and use of snake case)
day_one_month
day_one

# not optimal
the_first_day_of_the_month
dayone
DayOneMonth
dm1
```

---

### Do not overwrite objects


```r
# examples of wrong code

T <- FALSE

x <- seq(from = 1, to = 10)
mean <- function(x) sum(x)
mean(x)
```

---

### Break your lines and use indentation

```
# optimal
scdb_vote <- scdb_vote %>%
  mutate(chief = factor(chief,
                        levels = c("Jay", "Rutledge", "Ellsworth",
                                   "Marshall", "Taney", "Chase",
                                   "Waite", "Fuller", "White",
                                   "Taft", "Hughes", "Stone",
                                   "Vinson", "Warren", "Burger",
                                   "Rehnquist", "Roberts")))

# not optimal
scdb_vote <- mutate(scdb_vote, chief = factor(chief, levels = c("Jay", "Rutledge", "Ellsworth", "Marshall", "Taney", "Chase", "Waite", "Fuller", "White", "Taft", "Hughes", "Stone", "Vinson", "Warren", "Burger", "Rehnquist", "Roberts")))
```

---

### Calling functions that have the same name 

Sometimes functions have the same name in different packages. 

For example the `map()` function is defined both in the `purrr` package (to work with vectors and functions) and `maps` package (to create maps)

If you load both, by default R will use the function from the package most recently loaded:

```r
library(purrr)
library(maps)

map()
```

But what if you want to use the `map()` function from the `purrr` package?

---

### Calling functions that have the same name 

It is better to be intentional about which function to use. To do so:

use the `::` notation 

```r
library(purrr)
library(maps)

purrr::map()    # use map() from the purrr library
maps::map()     # use map() from the maps library
```

--

or avoid loading a given package, and just load the specific function that you need from it

```r
library(purrr)

map()           # use map() from the purrr library
maps::map()     # use map() from the maps library
```

---

### Use functions correctly

See assigned reading ["How to read an R help page"](https://socviz.co/appendix.html#how-to-read-an-r-help-page)

---

### Auto-formatting in R Studio

R Studio helps out with these issues:

* option 1: `Code > Reformat Code` (Shift + Cmd/Ctrl + A)
* option 2: `Code > Reindent Lines` (Cmd/Ctrl + I)
* option 3: install the package [`styler`](http://styler.r-lib.org/)

--

Open an R script, and try it out:
```
 y<-10
  if (y < 20) {
x <- "Too low" }   
else {
  x <-"Too high"}
```

<!-- * [This code example](/notes/style-guide/#exercise-style-this-code) -->

---

class: inverse, middle

## Condition handling

---

### Three types of conditions to handle

Coding style is one way to practice defensive programming and prevent bugs. 

The second way is condition handling: set up our code in a way that it tells us if something is problematic.

Three types of conditions:
* Errors (break your code)
* Warnings
* Messages

---

### Errors: Incorrect code or impossible requests in R

For example, this `addition()` function takes two arguments and adds them together. The `if-else` condition checks if either `x` or `y` is not a number. If that's TRUE, the `stop()` function triggers a error and notifies the user:

```{r error, error = TRUE, warning = FALSE}

addition <- function(x, y) {
  if (!is_numeric(c(x, y))) {
    stop("One of your inputs is not a number")
  } else {
    return(x + y)
  }
}

addition(3, "2")
```

---

### Errors: Incorrect code or impossible requests in R

A function can test for more than one error; but you need to check each of them separately with `if-else` statements. The function stops at the first error it encounters.

How to decide which errors to check for:

1. More conditional tests make the function more robust against incorrect uses 
1. Think about who is going to use that function and how frequently
1. Provide documentation to reduce the need for extensive testing.

---

### Warnings: Code runs but may have potential issues

For example, this code defines a function that takes as input `x` a probability value (between 0 and 1) and converts it to a natural logarithm value.

R will execute this code, but when the function is called with values outside the probability range, it gives a warning that says the result produces a “NaN” value ("Not a Number", impossible to calculate):

```{r logit, error = TRUE}

logit <- function(x) {
  return(log(x / (1 - x)))
}

logit(-1)
```

---

### Warnings: Code runs but may have potential issues

To fix this warning, we can... 

Option 1: add a condition that signals and triggers an error instead than a warning. For example, if `x` is not between 0 and 1, then stop the code:

```{r logit_error, error = TRUE}

logit <- function(x) {
  if (x < 0 | x > 1) {
    stop('x not between 0 and 1')
  } else {
    return(log(x / (1 - x)))
    }
}

logit(-1)
```

---

<!--

## Warnings

Same code of the previous slide, written more compactly:

```{r logit_error-compact, error = TRUE}

logit <- function(x) {
  if (x < 0 | x > 1) stop('x not between 0 and 1')
  log(x / (1 - x))
}

logit(-1)
```

Notice here we can write `if` and the condition one the same line without the `{}` and still preserve code legibility of this single `if` statement; we can also remove `return`

-->

### Warnings: Code runs but may have potential issues

Option 2: 
To avoid stopping the code, we can also fix a warning without triggering an error. For example, we can check if `x` is outside the given range; if so, replace it with a missing value and trigger a warning if `x` is a missing value.

```{r logit_error2, error = TRUE}

logit <- function(x) {
  x <- if_else(x < 0 | x > 1,
               NA_real_,
               x)
  if (is.na(x)) {
    warning('x not between 0 and 1') 
    return(log(x / (1 - x)))
    }
}

logit(-1)
```

---

### Messages: Informative notices

Messages do not indicate that something is wrong, but provide useful info to the user.

For example, here we are plotting with `geom_smooth()` which automatically decides which smoothing algorithm to use (default is `gam` based on sample size):

```{r message_ggplot, out.width = "35%"}
ggplot(diamonds, aes(carat, price)) +
  geom_point() + 
  geom_smooth()
```

---

### Messages: Informative notices

To write a message in your code, do not use the `print()` function, but the `message()` function"

```{r}
demo_message <- function() message("This is a message")
demo_message()
```

You can also suppress a message with `suppressMessages()` but this won't work if you create a message using `print()`:
```{r}
suppressMessages(demo_message())  # no output
```


