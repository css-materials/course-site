<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Debugging and defensive programming</title>
    <meta charset="utf-8" />
    <meta name="author" content="MACSS 30500   University of Chicago" />
    <script src="index_files/header-attrs/header-attrs.js"></script>
    <link href="index_files/panelset/panelset.css" rel="stylesheet" />
    <script src="index_files/panelset/panelset.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Debugging and defensive programming
]
.author[
### MACSS 30500 <br /> University of Chicago
]

---






class: inverse, middle

## Agenda

* Define a computer bug
* Defensive programming
  * Coding style
  * Condition handling
* Debugging


---

### Bugs

&gt; An error or flaw in a computer program that causes it to produce an incorrect result or to behave in unintended ways.

When we talk about a bug we refer to both a syntactic bug (a typo) and a bug due to lack of understanding R rules (how to data types, structures, etc.). 

Fixing the latter requires time and experience (aka not a fast fix), but we can fix the the first faster by working on our coding style!

--

Debugging includes:
* prevent bugs from occurring in the first place (defensive programming using coding style and condition handling)
* fix bugs once they occur


---

class: inverse, middle

## Defensive programming

---

### Two components of defensive programming

#### 1. Coding Style:
* Notation and names
* Syntax (spacing, curly braces, line length, indentation, assignment, etc.)
* Comments

#### 2. Failing fast:
* Condition handling


---

### Writing code

Programming |	Language
------------|----------
Scripts |	Essays
Sections | Paragraphs
Lines Breaks | Sentences
Parentheses |	Punctuation
Functions |	Verbs
Variables |	Nouns

---

### A text with no syntax

Text taken from a speech given by Ronald Reagan in 1987, after the spacial Challenger exploded on take off. Reagan's address: https://youtu.be/Qa7icmqgsow
 
"weve grown used to wonders in this century its hard to dazzle us but for 25 years the united states space program has been doing just that weve grown used to the idea of space and perhaps we forget that weve only just begun were still pioneers they the members of the Challenger crew were pioneers and i want to say something to the school children of America who were watching the live coverage of the shuttles takeoff i know it is hard to understand but sometimes painful things like this happen its all part of the process of exploration and discovery its all part of taking a chance and expanding mans horizons the future doesnt belong to the fainthearted it belongs to the brave the challenger crew was pulling us into the future and well continue to follow them the crew of the space shuttle challenger honored us by the manner in which they lived their lives we will never forget them nor the last time we saw them this morning as they prepared for the journey and waved goodbye and slipped the surly bonds of earth to touch the face of god"


---

### A text with syntax

"We've grown used to wonders in this century. It's hard to dazzle us. But for 25 years the United States space program has been doing just that. We've grown used to the idea of space, and perhaps we forget that we've only just begun. We're still pioneers. They, the members of the Challenger crew, were pioneers.

And I want to say something to the school children of America who were watching the live coverage of the shuttle's takeoff. I know it is hard to understand, but sometimes painful things like this happen. It's all part of the process of exploration and discovery. It's all part of taking a chance and expanding man's horizons. The future doesn't belong to the fainthearted; it belongs to the brave. The Challenger crew was pulling us into the future, and we'll continue to follow them....

The crew of the space shuttle Challenger honoured us by the manner in which they lived their lives. We will never forget them, nor the last time we saw them, this morning, as they prepared for the journey and waved goodbye and 'slipped the surly bonds of earth' to 'touch the face of God.'"

---

class: inverse, middle


## Style: review the [tidyverse style guide](https://style.tidyverse.org/)

We will review some key concepts, but make sure to check the full guide

---

### Short and clear object names

```r
# optimal (short and use of snake case)
day_one_month
day_one

# not optimal
the_first_day_of_the_month
dayone
DayOneMonth
dm1
```

---

### Do not overwrite objects


```r
# examples of wrong code

T &lt;- FALSE

x &lt;- seq(from = 1, to = 10)
mean &lt;- function(x) sum(x)
mean(x)
```

---

### Break your lines and use indentation

```
# optimal
scdb_vote &lt;- scdb_vote %&gt;%
  mutate(chief = factor(chief,
                        levels = c("Jay", "Rutledge", "Ellsworth",
                                   "Marshall", "Taney", "Chase",
                                   "Waite", "Fuller", "White",
                                   "Taft", "Hughes", "Stone",
                                   "Vinson", "Warren", "Burger",
                                   "Rehnquist", "Roberts")))

# not optimal
scdb_vote &lt;- mutate(scdb_vote, chief = factor(chief, levels = c("Jay", "Rutledge", "Ellsworth", "Marshall", "Taney", "Chase", "Waite", "Fuller", "White", "Taft", "Hughes", "Stone", "Vinson", "Warren", "Burger", "Rehnquist", "Roberts")))
```

---

### Calling functions with the same name 

Sometimes functions have the same name in different packages. 

For example the `map()` function is defined both in the `purrr` and `maps` package. By default, R will use the function from the package most recently loaded:


```r
library(purrr)
library(maps)

map()
```

But what if you want to use the `map()` function from the `purrr` package?

---

### Calling functions with the same name 

You always want to be intentional about which function to use. To do so:

use the `::` notation 

```r
library(purrr)
library(maps)

purrr::map()    # use map() from the purrr library
maps::map()     # use map() from the maps library
```

--

or avoid loading a given package, and just load the specific function that you need from it

```r
library(purrr)

map()           # use map() from the purrr library
maps::map()     # use map() from the maps library
```

---

### Use functions correctly

See assigned reading ["How to read an R help page"](https://socviz.co/appendix.html#how-to-read-an-r-help-page)

---

### Auto-formatting in R Studio

R Studio helps out with these issues:

* option 1: `Code &gt; Reformat Code` (Shift + Cmd/Ctrl + A)
* option 2: `Code &gt; Reindent Lines` (Cmd/Ctrl + I)
* option 3: install the package [`styler`](http://styler.r-lib.org/)

--

Open an R script, and try it out:
```
 y&lt;-10
  if (y &lt; 20) {
x &lt;- "Too low" }   
else {
  x &lt;-"Too high"}
```

&lt;!-- * [This code example](/notes/style-guide/#exercise-style-this-code) --&gt;

---

class: inverse, middle

## Condition handling

---

### Three types of conditions to handle

Coding style is one way to practice defensive programming and prevent bugs. The second way is condition handling: set up our code in a way that it tells us if something is problematic.

Three types of conditions:
* Errors (break your code)
* Warnings
* Messages

---

### Errors: code that is written incorrectly or asks R to do something that is not possible.

For example, this `addition()` function takes two arguments and adds them together. The `if-else` condition checks if either `x` or `y` is not a number. If that's TRUE, the `stop()` function triggers a error and notifies the user:


```r
addition &lt;- function(x, y) {
  if (!is_numeric(c(x, y))) {
    stop("One of your inputs is not a number")
  } else {
    return(x + y)
  }
}

addition(3, "2")
```

```
## Error in addition(3, "2"): One of your inputs is not a number
```

---

### Errors

A function can test for more than one error; you need to check each of them separately with multiple `if-else` statements. The function stops as soon as it encounters one of them.

How to determine what errors to check for?
1. The more conditional tests you build into the function, the more robust is the function against incorrect uses, BUT the longer it takes to write it
1. Think about who is going to use that function and how frequently
1. Can provide documentation on how to use the function to reduce tests

---

### Warnings: code runs but you might want to take a look, as it might be problematic.

For example, this code defines a function that takes as input `x` a probability value (between 0 and 1) and converts it to a natural logarithm value.

R will execute this code, but when the function is called with values outside the probability range, it gives a warning that says the result produces a “NaN” value ("Not a Number", impossible to calculate):


```r
logit &lt;- function(x) {
  return(log(x / (1 - x)))
}

logit(-1)
```

```
## Warning in log(x/(1 - x)): NaNs produced
```

```
## [1] NaN
```

---

### Warnings

To fix the warning, there are multiple options. 

Option 1: add a condition that signals and triggers an error instead than a warning. For example, if `x` is not between 0 and 1, then stop the code:


```r
logit &lt;- function(x) {
  if (x &lt; 0 | x &gt; 1) {
    stop('x not between 0 and 1')
  } else {
    return(log(x / (1 - x)))
    }
}

logit(-1)
```

```
## Error in logit(-1): x not between 0 and 1
```
---

&lt;!--

## Warnings

Same code of the previous slide, written more compactly:


```r
logit &lt;- function(x) {
  if (x &lt; 0 | x &gt; 1) stop('x not between 0 and 1')
  log(x / (1 - x))
}

logit(-1)
```

```
## Error in logit(-1): x not between 0 and 1
```

Notice here we can write `if` and the condition one the same line without the `{}` and still preserve code legibility of this single `if` statement; we can also remove `return`

--&gt;

### Warnings

Option 2: if we do not want to stop the code from running, we can also fix the warning in other ways, without triggering an error. For example we can check if `x` is outside the range; if so, replace it with a missing value and trigger a warning if `x` is a missing value


```r
logit &lt;- function(x) {
  x &lt;- if_else(x &lt; 0 | x &gt; 1,
               NA_real_,
               x)
  if (is.na(x)) {
    warning('x not between 0 and 1') 
    return(log(x / (1 - x)))
    }
}

logit(-1)
```

```
## Warning in logit(-1): x not between 0 and 1
```

```
## [1] NA
```

---

### Messages: do not indicate that something is wrong, but provide useful info to the user.

For example, here we are plotting with `geom_point()` and `geom_smooth()`, which automatically decides which smoothing algorithm (default is `gam` based on sample size):


```r
ggplot(diamonds, aes(carat, price)) +
  geom_point() + geom_smooth()
```

```
## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
```

&lt;img src="index_files/figure-html/message_ggplot-1.png" width="35%" style="display: block; margin: auto;" /&gt;

---

### Messages

To write a message in your code, do not use the `print()` function, but the `message()` function"


```r
demo_message &lt;- function() message("This is a message")
demo_message()
```

```
## This is a message
```

You can also suppress a message with `suppressMessages()` (this won't work if you create a message using `print()`):

```r
suppressMessages(demo_message())  # no output
```

---

class: inverse, middle

## Debugging

Make sure to review "Debugging R code" in [What They Forgot to Teach You About R](https://rstats.wtf/debugging-r), here we reveiw some selected points

---

### Basic debugging techniques

1. Realize that you have a bug

1. Figure out where it is
   - read your code out loud
   - use `print()` statements to print line-by-line

1. Fix it

---

### The call stack

**Often times, when we run a piece of code the actual cause of the problem is not in the line we run.** 

For example, here we have two functions: `f` is a function that takes an input `x` and does something with it' `g` is a function that calls the function `f` 

The problem is in function `f`, but let's say in our code we call function `g`:


```r
f &lt;- function(x) x + 1
g &lt;- function(x) f(x)
g("a")
```

```
## Error in x + 1: non-numeric argument to binary operator
```

---

### The call stack

We cannot fix function `g`, because the problem does not occur there. We need to fix function `f` which triggers the entire call sequence. 

Use `traceback()`, which is often shown automatically in RStudio, and read it from bottom to top. The line at the top is where the error occurred:


```r
traceback()
2: f(x) at #1
1: g("a")
```


---

## Acknowledgments 

The content of these slides is derived in part from Benjamin Soltoff’s “Computing for the Social Sciences” course materials, licensed under the CC BY NC 4.0 Creative Commons License. Any errors or oversights are mine alone.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "magula",
"highlightLines": true,
"highlightLanguage": "r",
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
