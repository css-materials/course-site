<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Debugging and defensive programming</title>
    <meta charset="utf-8" />
    <meta name="author" content="MACSS 30500   University of Chicago" />
    <script src="index_files/header-attrs/header-attrs.js"></script>
    <link href="index_files/panelset/panelset.css" rel="stylesheet" />
    <script src="index_files/panelset/panelset.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Debugging and defensive programming
]
.author[
### MACSS 30500 <br /> University of Chicago
]

---






class: inverse, middle

# R Base Data Structures

---

## Bugs

&gt; An error, flaw, failure or fault in a computer program or system that causes it to produce an incorrect or unexpected result, or to behave in unintended ways.

When we talk about a bug mostly we refer to a syntactic error or a typo, but a bug is also related to understanding R rules, data types, structures, and how to use functions. Computers are powerful tools but you need to follow their rules

Debugging has two goals:
* Prevent bugs from occurring in the first place
* Fix bugs once they occur

**Debugging (like programming) requires patience!** 
.

---

class: inverse, middle

# Defensive programming

---

## Defensive programming

Two elements of defensive programming...

**Style guide for writing code:**
* Notation and naming guide (file names, object names, etc.)
* Syntax (spacing, curly braces, line length, indentation, assignment, calling functions)
* Comments (# and space)
* Auto-formatting in RStudio

**Failing fast:**
* Condition handling


---

## Writing code

Programming |	Language
------------|----------
Scripts |	Essays
Sections | Paragraphs
Lines Breaks | Sentences
Parentheses |	Punctuation
Functions |	Verbs
Variables |	Nouns

---

### A text with no syntax

Text taken from a speech given by Ronald Reagan in 1987, after the spacial Challenger exploded on take off. Reagan's address: https://youtu.be/Qa7icmqgsow
 
"weve grown used to wonders in this century its hard to dazzle us but for 25 years the united states space program has been doing just that weve grown used to the idea of space and perhaps we forget that weve only just begun were still pioneers they the members of the Challenger crew were pioneers and i want to say something to the school children of America who were watching the live coverage of the shuttles takeoff i know it is hard to understand but sometimes painful things like this happen its all part of the process of exploration and discovery its all part of taking a chance and expanding mans horizons the future doesnt belong to the fainthearted it belongs to the brave the challenger crew was pulling us into the future and well continue to follow them the crew of the space shuttle challenger honored us by the manner in which they lived their lives we will never forget them nor the last time we saw them this morning as they prepared for the journey and waved goodbye and slipped the surly bonds of earth to touch the face of god"


---

### A text with syntax

"We've grown used to wonders in this century. It's hard to dazzle us. But for 25 years the United States space program has been doing just that. We've grown used to the idea of space, and perhaps we forget that we've only just begun. We're still pioneers. They, the members of the Challenger crew, were pioneers.

And I want to say something to the school children of America who were watching the live coverage of the shuttle's takeoff. I know it is hard to understand, but sometimes painful things like this happen. It's all part of the process of exploration and discovery. It's all part of taking a chance and expanding man's horizons. The future doesn't belong to the fainthearted; it belongs to the brave. The Challenger crew was pulling us into the future, and we'll continue to follow them....

The crew of the space shuttle Challenger honoured us by the manner in which they lived their lives. We will never forget them, nor the last time we saw them, this morning, as they prepared for the journey and waved goodbye and 'slipped the surly bonds of earth' to 'touch the face of God.'"

---

## Object names

```r
# Optimal (short and use of snake case)
day_one
day_1

# Not optimal
first_day_of_the_month
DayOne
dayone
djm1
```

The tidyverse style guide https://style.tidyverse.org/

---

## Overwriting objects

Avoid assigning the same to object or functions that already exists in R or assigning something wrong:

```r
# Not Good

T &lt;- FALSE

c &lt;- 10

x &lt;- seq(from = 1, to = 10)
mean &lt;- function(x) sum(x)
mean(x)
```

---

## Line length

R does not necessary require you to split your code across multiple lines in order to run, but it is good practice to do so:

```r
# Optimal
scdbv &lt;- scdbv %&gt;%
  mutate(chief = factor(chief,
                        levels = c("Jay", "Rutledge", "Ellsworth",
                                   "Marshall", "Taney", "Chase",
                                   "Waite", "Fuller", "White",
                                   "Taft", "Hughes", "Stone",
                                   "Vinson", "Warren", "Burger",
                                   "Rehnquist", "Roberts")))

# Not optimal
scdbv &lt;- mutate(scdbv, chief = factor(chief, levels = c("Jay", "Rutledge", "Ellsworth", "Marshall", "Taney", "Chase", "Waite", "Fuller", "White", "Taft", "Hughes", "Stone", "Vinson", "Warren", "Burger", "Rehnquist", "Roberts")))
```

---

## Indentation

Indentation makes the code more readable. For example, it is helpful to identify which values are part of which function:

```r
# in a mutate() function
scdbv &lt;- scdbv %&gt;%
  mutate(majority = majority - 1,
         chief = factor(chief,
                        levels = c("Jay", "Rutledge", "Ellsworth",
                                   "Marshall", "Taney", "Chase",
                                   "Waite", "Fuller", "White",
                                   "Taft", "Hughes", "Stone",
                                   "Vinson", "Warren", "Burger",
                                   "Rehnquist", "Roberts")))
```

---

## Calling functions

If you are using functions that you have not written (e.g., from packages), you do not have the ability to rename them. Sometimes functions have the **same name across different packages**:

```r
library(purrr)
map()
```
--

```r
library(purrr)
library(maps)

map()
```
--

`map()` is defined both in the `purrr` and `maps` package. By default, R will call the function from the package most recently loaded.

---

## `::` notation

To fix this problem, we can detach and re-attach a package, but more frequently we use the `::` notation 

```r
library(purrr)
library(maps)

purrr::map()    # use map() from the purrr library
maps::map()     # use map() from the maps library
```

--

We can also avoid loading a given package, and just load the specific function that we need from it: 

```r
library(purrr)

map()           # use map() from the purrr library
maps::map()     # use map() from the maps library
```

---

## Auto-formatting in RStudio

RStudio helps out with these issues:

* `Code &gt; Reformat Code` (Shift + Cmd/Ctrl + A)
* `Code &gt; Reindent Lines` (Cmd/Ctrl + I)
* For better help see [`styler`](http://styler.r-lib.org/)

&lt;!-- * [This code example](/notes/style-guide/#exercise-style-this-code) --&gt;

---

class: inverse, middle

# Condition handling

---

## Condition handling

**Coding style** is one way to practice defensive programming and prevent bugs.  
Another way is to set up our code in a way that it tells us if something is potentially problematic: this is known as **condition handling**. 

Three types of conditions:
* (Fatal) Errors
* Warnings
* Messages

---

## Errors

Code is written incorrectly or asks to do something that is not possible. Notice the `stop()` function triggers a error in R and notifies the user of it:


```r
addition &lt;- function(x, y){

    if(!is_numeric(c(x, y))) 
    stop("One of your inputs is not a number.")
  
  x + y
}

addition(3, "abc")
```

```
## Error in addition(3, "abc"): One of your inputs is not a number.
```

---

## Warnings

Code runs but you might want to take a look. For example this code is transforming a probability to log odd. Our `x` is a probability value (between 0 and 1) and we want to convert it to a log odd (odds ratio and natural log).

R will execute this code, but it gives a warning that says the result produces a “NaN” value:


```r
logit &lt;- function(x){
  
  log(x / (1 - x))
}

logit(-1)
```

```
## Warning in log(x/(1 - x)): NaNs produced
```

```
## [1] NaN
```

---

## Warnings

To fix the warning, we can add a condition that signals and triggers an error instead than a warning (e.g., if `x` not between 0 and 1, stop the code):


```r
logit &lt;- function(x){
  
 if (x &lt; 0 | x &gt; 1) 
   stop('x not between 0 and 1')
  
 log(x / (1 - x))
}

logit(-1)
```

```
## Error in logit(-1): x not between 0 and 1
```

&lt;!--
We could also add a warning, if we do not want to stop the code:


```r
logit &lt;- function(x){
  x &lt;- if_else(x &lt; 0 | x &gt; 1, NA_real_, x)
  if (is.na(x)) warning('x not between 0 and 1')
  log(x / (1 - x))
}

logit(-1)
```

```
## Warning in logit(-1): x not between 0 and 1
```

```
## [1] NA
```
--&gt;

---

## Messages

Messages are the least troublesome condition. Messages do not indicate that something is wrong, but they provide info that is important for the reader to be aware of.

For ex., here we are plotting with `geom_point()` and `geom_smooth()`, which automatically decides which smoothing algorithm to use (default is `gam` based on sample size):


```r
ggplot(diamonds, aes(carat, price)) +
  geom_point() + geom_smooth()
```

```
## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
```

&lt;img src="index_files/figure-html/message_ggplot-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

## Suppressing messages

There is a difference between creating a massage with `message()` and printing text with `print()`

You can write a message with `message()` and suppress it, if you want, with `suppressMessages()`:

```
demo_message &lt;- function() message("This is a message")
demo_message()
suppressMessages(demo_message())  # no output
```

But if you write a message with `print()` there is no way to suppress it:
```
demo_print &lt;- function() print("This is a message")
demo_print()
suppressMessages(demo_print())  # still output
```

---

class: inverse, middle

# Debugging

---

## Debugging techniques

1. Realize that you have a bug
1. Make it repeatable
1. Figure out where it is
1. Fix it

---

## The call stack

Often times, when we run a piece of code the actual cause of the problem is not necessarily in the line we run. 

For example, here we have several functions that call other functions: `f` is a function that takes an input `a` and passes it into another function `g`; `g` takes an input `b` and passes it into function `h`, etc. 

The problem here is in function `i`, but let's say we call function `f` in our code:


```r
f &lt;- function(a) g(a)
g &lt;- function(b) h(b)
h &lt;- function(c) i(c)
i &lt;- function(d) "a" + d

f(10)
```

```
## Error in "a" + d: non-numeric argument to binary operator
```

---

## The call stack

We cannot fix function `f`, because the problem does not occur there. We need to fix function `i` which triggers a call sequence. 

Use `traceback()`, which is often shown automatically in RStudio, and read it from bottom to top. The line at the top is where the error occurred:


```r
traceback()
```

```
# 4: i(c) at exceptions-example.R#3
# 3: h(b) at exceptions-example.R#2
# 2: g(a) at exceptions-example.R#1
# 1: f(10)
```
---

## Acknowledgments 

The content of these slides is derived in part from Benjamin Soltoff’s “Computing for the Social Sciences” course materials, licensed under the CC BY NC 4.0 Creative Commons License. Any errors or oversights are mine alone.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "magula",
"highlightLines": true,
"highlightLanguage": "r",
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
